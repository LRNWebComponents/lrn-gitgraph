<link rel="import" href="../polymer/polymer.html">
<script src="./libraries/gitgraph.js/src/gitgraph.js"></script>
<link rel="stylesheet" type="text/css" href="./libraries/gitgraph.js/src/gitgraph.css" />
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
`lrn-gitgraph`
A LRN element

@demo demo/index.html
-->

<dom-module id="lrn-gitgraph">
  <template>
    <style>
      :host {
        display: block;
        overflow-x: scroll;
      }
    </style>
    <canvas id="gitGraph"></canvas>
    <iron-ajax
       auto
       url="/demo/api.json"
       handle-as="json"
       on-response="handleResponse"></iron-ajax>
  </template>
  <script>
    Polymer({

      is: 'lrn-gitgraph',

      properties: {
        template: {
          type: String,
          value: 'blackarrow',
        },
        orientation: {
          type: String,
          value: 'horizontal'
        },
        mode: {
          type: String,
          value: ''
        },
        reverseArrow: {
          type: Boolean,
          value: false,
        },
        commits: {
          type: Array,
          value: []
        },
        config: {
          type: Object
        }
      },
      handleResponse: function(res) {
        var root = this;
        var response = res.detail.response.data;
        if (response) {
          root.commits = response;
        }
      },
      observers: [
        '_commitsChanged(commits)'
      ],
      _commitsChanged: function(logcommits) {
        var root = this;
        if (root.config) {
          if (logcommits.length > 0) {
            var gitgraph = new GitGraph(root.config);
            logcommits.forEach(function(logcommit, i) {
              var commitObj = {
                message: logcommit.subject,
                sha1: logcommit.commit,
                tag: logcommit.refs
              };
              // if this is the first commit create the master branch
              if (i === 0) {
                var master = gitgraph.branch('master');
                master.commit(commitObj);
              }
              else {
                if (logcommit.parent !== '') {
                  var parentCommit = root._getCommit(logcommit.parent, gitgraph.commits);
                  var branch = parentCommit.branch;
                  var hasChild = root._commitHasChild(logcommit.parent, logcommits);
                  if (hasChild) {
                    var newbranch = branch.branch(logcommit.commit);
                    newbranch.commit(commitObj);
                  }
                  else {
                    branch.commit(commitObj);
                  }
                }
              }
            });
          }
        }
      },
      _getCommit: function(commitId, commits) {
        var commit = false;
        commits.forEach(function(c) {
          if (c.sha1 === commitId) {
            commit = c;
          }
        });
        return commit;
      },
      _commitHasChild: function(commitId, commits) {
        var hasChild = false;
        var track = [];
        commits.forEach(function(c, i) {
          track[c.parent] = 0;
        });
        commits.forEach(function(c, i) {
          track[c.parent]++;
        });
        commits.forEach(function(c, i) {
          if (c.parent === commitId && track[c.parent] > 1) {
            hasChild = true;
          }
        });
        return hasChild;
      },
      ready: function() {
        var root = this;
        /***********************
         *    INITIALIZATION   *
         ***********************/
        var config = {
          template: root.template, // could be: "blackarrow" or "metro" or `myTemplate` (custom Template object)
          reverseArrow: false, // to make arrows point to ancestors, if displayed
          orientation: root.orientation,
          element: root.$$('#gitGraph')
        };
        // if (root.mode !== '') {
        //   config.mode = root.mode;
        // }
        root.config = config;
      }
    });
  </script>
</dom-module>
